import Foundation
import Contacts
import Capacitor

@objc public class EmailAddress: NSObject {
    var isPrimary: Bool?
    var label: String?
    var type: EmailAddressType
    var value: String

    init(isPrimary: Bool?, label: String?, type: EmailAddressType, value: String) {
        self.isPrimary = isPrimary
        self.label = label
        self.type = type
        self.value = value
    }

    init(_ data: CNLabeledValue<NSString>) {
        let type = EmailAddressType.fromLabel(data.label) ?? .other

        self.label = type == .custom ? data.label : nil
        self.type = type
        self.value = data.value as String
    }

    init(_ data: JSObject) throws {
        if let isPrimary = data["isPrimary"] as? Bool {
            self.isPrimary = isPrimary
        }
        if let label = data["label"] as? String {
            self.label = label
        }
        if let type = data["type"] as? String {
            if let emailAddressType = EmailAddressType(rawValue: type) {
                self.type = emailAddressType
            } else {
                throw CustomError.typeInvalid
            }
        } else {
            self.type = .other
        }
        if let value = data["value"] as? String {
            self.value = value
        } else {
            throw CustomError.valueMissing
        }
    }

    public func toCNLabeledValue() -> CNLabeledValue<NSString> {
        return CNLabeledValue(
            label: type.toLabel() ?? label ?? "",
            value: value as NSString
        )
    }

    public func toJSObject() -> JSObject {
        var result = JSObject()
        result["isPrimary"] = isPrimary
        result["label"] = label
        result["type"] = type.rawValue
        result["value"] = value
        return result
    }
}
