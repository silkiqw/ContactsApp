import Foundation
import Contacts
import Capacitor

@objc public class UrlAddress: NSObject {
    var label: String?
    var type: UrlAddressType
    var value: String

    init(value: String, type: UrlAddressType) {
        self.type = type
        self.value = value
    }

    init(_ data: CNLabeledValue<NSString>) {
        let type = UrlAddressType.fromLabel(data.label) ?? .other

        self.label = type == .custom ? data.label : nil
        self.type = type
        self.value = data.value as String
    }

    init(_ data: JSObject) throws {
        if let label = data["label"] as? String {
            self.label = label
        }
        if let type = data["type"] as? String {
            if let urlAddressType = UrlAddressType(rawValue: type) {
                self.type = urlAddressType
            } else {
                throw CustomError.typeInvalid
            }
        } else {
            self.type = .other
        }
        if let value = data["value"] as? String {
            self.value = value
        } else {
            throw CustomError.valueMissing
        }
    }

    public func toCNLabeledValue() -> CNLabeledValue<NSString> {
        return CNLabeledValue(
            label: type.toLabel() ?? label ?? "",
            value: value as NSString
        )
    }

    public func toJSObject() -> JSObject {
        var result = JSObject()
        result["label"] = label
        result["type"] = type.rawValue
        result["value"] = value
        return result
    }
}
